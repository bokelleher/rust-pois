<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>POIS Event Monitor</title>
  <link rel="stylesheet" href="/static/app.css">
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <a href="/">
        <img src="https://esni.techexlab.com:3000/static/media/techex-logo.74b1230112edda6b3915.png" 
             alt="TechExLab" class="logo">
      </a>
    </div>
    <nav class="nav">
      <a href="/static/admin.html">Channels & Rules</a>
      <a href="/static/tools.html">SCTE-35 Builder</a>
      <a href="/static/events.html" class="active">Event Monitor</a>
    </nav>
    <div class="spacer"></div>
    <div class="right">
      <input type="text" id="headerTokenInput" placeholder="Bearer token" 
             style="width: 200px; height: 32px; padding: 6px 12px; font-size: 13px;"
             oninput="localStorage.setItem('pois_token', this.value); updateTokenDisplay()">
      <span id="tokenDisplay" style="margin-left: 8px;">⚠ not set</span>
    </div>
  </header>

  <main class="content events-max-width">
    <div class="flex justify-between items-center mb-6">
      <h1>ESAM Event Monitor</h1>
      <div class="auto-refresh">
        <label class="flex items-center gap-2">
          <input type="checkbox" id="autoRefresh" checked>
          <span>Auto-refresh (30s)</span>
        </label>
        <button class="btn btn-primary" id="refreshBtn">Refresh Now</button>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalEvents">--</div>
        <div class="stat-label">Total Events</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="last24hEvents">--</div>
        <div class="stat-label">Last 24h</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avgProcessingTime">--</div>
        <div class="stat-label">Avg Time (ms)</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="actionBreakdown">--</div>
        <div class="stat-label">Actions</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="panel" style="margin-top: 24px;">
      <div class="form-row">
        <div class="form-group">
          <label for="channelFilter">Channel</label>
          <input type="text" id="channelFilter" placeholder="All channels">
        </div>
        <div class="form-group">
          <label for="actionFilter">Action</label>
          <select id="actionFilter">
            <option value="">All actions</option>
            <option value="noop">No-op</option>
            <option value="delete">Delete</option>
            <option value="replace">Replace</option>
          </select>
        </div>
        <div class="form-group">
          <label for="limitFilter">Limit</label>
          <select id="limitFilter">
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
          </select>
        </div>
        <button class="btn btn-primary" id="applyFiltersBtn" style="align-self: flex-end;">Apply Filters</button>
      </div>
    </div>

    <!-- Events Table -->
    <div class="panel" style="margin-top: 24px; overflow-x: auto;">
      <table class="events-table">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Channel</th>
            <th>Action</th>
            <th>Message</th>
            <th>Processing (ms)</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="eventsTableBody">
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-secondary);">
              Loading events...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="flex justify-between items-center" style="margin-top: 24px;">
      <button class="btn" id="prevPageBtn" disabled>← Previous</button>
      <span id="pageInfo">Page 1</span>
      <button class="btn" id="nextPageBtn">Next →</button>
    </div>
  </main>

  <!-- Event Detail Modal -->
  <div id="eventModal" class="modal">
    <div class="modal-backdrop" onclick="closeModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>Event Details</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div id="eventDetails" class="modal-body"></div>
    </div>
  </div>

  <script>
    // Token management
    function updateTokenDisplay() {
      const token = localStorage.getItem('pois_token') || '';
      document.getElementById('tokenDisplay').textContent = token ? '✓ set' : '⚠ not set';
    }

    // Load token on page load
    document.addEventListener('DOMContentLoaded', function() {
      const token = localStorage.getItem('pois_token') || '';
      document.getElementById('headerTokenInput').value = token;
      updateTokenDisplay();
      loadStatistics();
      loadEvents();
    });

    // State
    let currentPage = 1;
    let currentLimit = 50;
    let autoRefreshInterval = null;

    // API calls
    async function apiCall(endpoint) {
      const token = localStorage.getItem('pois_token') || '';
      const response = await fetch(`/api${endpoint}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return response.json();
    }

    async function loadStatistics() {
      try {
        const stats = await apiCall('/events/stats');
        document.getElementById('totalEvents').textContent = stats.total_events || 0;
        document.getElementById('last24hEvents').textContent = stats.last_24h_events || 0;
        document.getElementById('avgProcessingTime').textContent = 
          stats.avg_processing_time_ms ? stats.avg_processing_time_ms.toFixed(1) : '--';
        
        const actions = stats.action_counts || {};
        const actionText = `${actions.noop || 0}n / ${actions.delete || 0}d / ${actions.replace || 0}r`;
        document.getElementById('actionBreakdown').textContent = actionText;
      } catch (error) {
        console.error('Failed to load statistics:', error);
      }
    }

    async function loadEvents() {
      const channel = document.getElementById('channelFilter').value;
      const action = document.getElementById('actionFilter').value;
      const limit = parseInt(document.getElementById('limitFilter').value);
      const offset = (currentPage - 1) * limit;

      let endpoint = `/events?limit=${limit}&offset=${offset}`;
      if (channel) endpoint += `&channel=${encodeURIComponent(channel)}`;
      if (action) endpoint += `&action=${encodeURIComponent(action)}`;

      try {
        const events = await apiCall(endpoint);
        renderEvents(events);
        document.getElementById('pageInfo').textContent = `Page ${currentPage}`;
        document.getElementById('prevPageBtn').disabled = currentPage === 1;
        document.getElementById('nextPageBtn').disabled = events.length < limit;
      } catch (error) {
        console.error('Failed to load events:', error);
        document.getElementById('eventsTableBody').innerHTML = `
          <tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--error);">
            Failed to load events: ${error.message}
          </td></tr>
        `;
      }
    }

    function renderEvents(events) {
      const tbody = document.getElementById('eventsTableBody');
      if (events.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-secondary);">
            No events found
          </td></tr>
        `;
        return;
      }

      tbody.innerHTML = events.map(event => `
        <tr>
          <td>${new Date(event.timestamp).toLocaleString()}</td>
          <td>${event.channel_name}</td>
          <td><span class="badge badge-${event.action}">${event.action}</span></td>
          <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${event.esam_signal_id || '--'}
          </td>
          <td>${event.processing_time_ms ? event.processing_time_ms.toFixed(1) : '--'}</td>
          <td><button class="btn-sm" onclick="showEventDetails(${event.id})">View</button></td>
        </tr>
      `).join('');
    }

    async function showEventDetails(eventId) {
      try {
        const event = await apiCall(`/events/${eventId}`);
        const details = document.getElementById('eventDetails');
        details.innerHTML = `
          <div class="detail-grid">
            <div class="detail-item"><strong>ID:</strong> ${event.id}</div>
            <div class="detail-item"><strong>Channel:</strong> ${event.channel_name}</div>
            <div class="detail-item"><strong>Action:</strong> ${event.action}</div>
            <div class="detail-item"><strong>Timestamp:</strong> ${new Date(event.timestamp).toLocaleString()}</div>
            <div class="detail-item"><strong>Processing Time:</strong> ${event.processing_time_ms ? event.processing_time_ms.toFixed(2) + ' ms' : '--'}</div>
            <div class="detail-item"><strong>ESAM Signal ID:</strong> ${event.esam_signal_id || '--'}</div>
            ${event.esam_xml ? `<div class="detail-item" style="grid-column: 1 / -1;">
              <strong>ESAM XML:</strong>
              <pre style="background: var(--field-bg); padding: 12px; border-radius: 8px; overflow-x: auto; margin-top: 8px;">${event.esam_xml}</pre>
            </div>` : ''}
            ${event.scte35_base64 ? `<div class="detail-item" style="grid-column: 1 / -1;">
              <strong>SCTE-35:</strong>
              <pre style="background: var(--field-bg); padding: 12px; border-radius: 8px; overflow-x: auto; margin-top: 8px;">${event.scte35_base64}</pre>
            </div>` : ''}
          </div>
        `;
        document.getElementById('eventModal').classList.add('show');
      } catch (error) {
        alert('Failed to load event details: ' + error.message);
      }
    }

    function closeModal() {
      document.getElementById('eventModal').classList.remove('show');
    }

    // Event listeners
    document.getElementById('refreshBtn').addEventListener('click', () => {
      loadStatistics();
      loadEvents();
    });

    document.getElementById('applyFiltersBtn').addEventListener('click', () => {
      currentPage = 1;
      loadEvents();
    });

    document.getElementById('prevPageBtn').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        loadEvents();
      }
    });

    document.getElementById('nextPageBtn').addEventListener('click', () => {
      currentPage++;
      loadEvents();
    });

    document.getElementById('autoRefresh').addEventListener('change', (e) => {
      if (e.target.checked) {
        autoRefreshInterval = setInterval(() => {
          loadStatistics();
          loadEvents();
        }, 30000);
      } else {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
      }
    });

    // Start auto-refresh
    autoRefreshInterval = setInterval(() => {
      loadStatistics();
      loadEvents();
    }, 30000);

    // Close modal on outside click
    document.getElementById('eventModal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-backdrop')) {
        closeModal();
      }
    });
  </script>
</body>
</html>